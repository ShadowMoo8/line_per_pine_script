<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Line‑by‑Line Script Generator — Robust (MetaMask-safe)</title>
  <style>
    :root{--bg:#0b0c10;--muted:#8b93a7;--text:#e6e9f0;--accent:#7c5cff;--accent-2:#2ee6a6;--danger:#ff5c7a;--border:#232838}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:radial-gradient(1200px 600px at 80% -10%,#1a2030 0,transparent 60%),var(--bg);line-height:1.5}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0}.tag{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:1.1fr .9fr}@media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 8px;padding:16px 16px 0;font-size:14px;color:#cfd6ea}.card .body{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}input[type=text],input[type=number],input[type=password],textarea,select{width:100%;background:#0f1320;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none;transition:border .2s,box-shadow .2s;font-size:14px}textarea{min-height:120px;resize:vertical}input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,92,255,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}@media(max-width:680px){.row,.row-3{grid-template-columns:1fr}}
    .btns{display:flex;gap:8px;flex-wrap:wrap}button{background:var(--accent);border:1px solid transparent;color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:transform .05s ease,opacity .2s ease,background .2s ease;font-size:14px}button.secondary{background:#111628;border-color:var(--border);color:#d7ddf2}button.ghost{background:transparent;border-color:var(--border);color:var(--muted)}button.success{background:var(--accent-2)}button.danger{background:var(--danger)}button:disabled{opacity:.6;cursor:not-allowed}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1320;font-size:12px;color:var(--muted)}
    .line{background:#0e1220;border:1px dashed #2a3150;padding:12px;border-radius:12px}.line.pending{border-style:solid;border-color:#3a4575}.line.approved{border-color:#294f44;background:#0d1a17}
    .log{height:220px;overflow:auto;background:#0e1220;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:12px;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.kpi .item{background:#0f1320;border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}.kpi .n{font-weight:800;font-size:18px}.kpi .l{color:var(--muted);font-size:12px}
    .footer{text-align:center;color:var(--muted);font-size:12px;margin-top:16px}.copy{user-select:all}.top-right{display:flex;gap:8px;align-items:center}.note{font-size:12px;color:var(--muted);margin-top:8px}
    .danger-box{background:#2b1219;border:1px solid #5a2b36;padding:10px;border-radius:10px;margin-top:8px;color:#ffb6c1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Line‑by‑Line Script Generator — Robust</h1>
      <div class="top-right"><div class="tag">Approve lines → build short scripts</div></div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Creative Brief & Controls</h3>
        <div class="body">
          <label for="sfs_brief">Describe your content (niche, persona, platform, angle, tone, CTA, constraints):</label>
          <textarea id="sfs_brief" placeholder="Example: TikTok for busy founders. Tone: punchy, contrarian. Hook first. CTA: comment 'START'."></textarea>

          <div class="row" style="margin-top:8px">
            <div>
              <label for="sfs_lines">Target lines</label>
              <input id="sfs_lines" type="number" min="1" max="60" step="1" value="12" />
            </div>
            <div>
              <label for="sfs_maxWords">Max words per line</label>
              <input id="sfs_maxWords" type="number" min="2" max="40" step="1" value="14" />
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div>
              <label for="sfs_model">Model</label>
              <input id="sfs_model" type="text" value="gpt-5-mini" />
            </div>
            <div>
              <label for="sfs_temperature">Creativity (temperature 0–1)</label>
              <input id="sfs_temperature" type="number" min="0" max="1" step="0.1" value="0.6" />
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div>
              <label for="sfs_apiKey">OpenAI API key (stored locally)</label>
              <input id="sfs_apiKey" type="password" placeholder="sk-... (or leave blank for Demo mode)" />
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="btns">
                <button id="sfs_start">Start</button>
                <button id="sfs_stop" class="danger" disabled>Stop</button>
                <button id="sfs_reset" class="ghost">Reset</button>
              </div>
            </div>
          </div>

          <div style="margin-top:8px" class="row">
            <div>
              <label for="sfs_demo">Self-test / Demo mode</label>
              <select id="sfs_demo"><option value="0">Live (OpenAI)</option><option value="1">Demo mode (no API)</option></select>
            </div>
            <div>
              <label for="sfs_selftest">Run self-test</label>
              <div class="btns"><button id="sfs_selftest" class="secondary">Run demo test (6 lines)</button></div>
            </div>
          </div>

          <div class="status" style="margin-top:10px">
            <span class="pill" id="sfs_statePill">Idle</span>
            <span id="sfs_statusText">Ready.</span>
          </div>

          <div class="kpi" style="margin-top:12px">
            <div class="item"><div class="n" id="sfs_kpiApproved">0</div><div class="l">Approved</div></div>
            <div class="item"><div class="n" id="sfs_kpiRemaining">0</div><div class="l">Remaining</div></div>
            <div class="item"><div class="n" id="sfs_kpiTries">0</div><div class="l">Regens</div></div>
            <div class="item"><div class="n" id="sfs_kpiWords">0</div><div class="l">Avg words/line</div></div>
          </div>

          <div class="note">If you previously saw a "Failed to connect to MetaMask" error: that usually comes from a browser extension interfering with network calls. This page avoids touching extension APIs; if you still see errors, use <b>Demo mode</b> or test in a private window with extensions disabled.</div>

          <div class="danger-box" id="sfs_warningBox" style="display:none">Extension error detected. The app has caught it and will keep running. See Activity Log for details.</div>
        </div>
      </div>

      <div class="card">
        <h3>Line Review</h3>
        <div class="body">
          <div id="sfs_pending" class="line pending" style="min-height:70px">No line yet. Click <b>Start</b> or run the demo test.</div>

          <div class="btns" style="margin-top:10px">
            <button id="sfs_approve" class="success" disabled>Approve</button>
            <button id="sfs_revise" class="secondary" disabled>Ask to revise</button>
            <button id="sfs_regen" class="ghost" disabled>Regenerate</button>
            <button id="sfs_skip" class="ghost" disabled>Skip</button>
          </div>

          <div id="sfs_reviseBox" style="display:none;margin-top:10px">
            <label for="sfs_reviseText">Revision guidance (e.g. "+more punch, remove jargon")</label>
            <input id="sfs_reviseText" type="text" placeholder="How should this be changed?" />
            <div class="btns" style="margin-top:8px">
              <button id="sfs_applyRevise" class="secondary">Apply revision</button>
              <button id="sfs_cancelRevise" class="ghost">Cancel</button>
            </div>
          </div>

          <h3 style="margin-top:18px">Approved Lines</h3>
          <div id="sfs_approvedList" class="body" style="padding:0;max-height:260px;overflow:auto">
            <ol id="sfs_approved" style="margin:0;padding:0 18px 8px 24px"></ol>
          </div>

          <div class="btns" style="margin-top:8px">
            <button id="sfs_copyAll" class="secondary">Copy all</button>
            <button id="sfs_downloadTxt" class="ghost">Download .txt</button>
            <button id="sfs_downloadMd" class="ghost">Download .md</button>
            <button id="sfs_simMeta" class="ghost">Simulate MetaMask error</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Activity Log</h3>
      <div class="body">
        <div id="sfs_log" class="log"></div>
        <div class="footer">This app runs client-side. Use Demo mode to test without an API key. If you want a production-safe setup, ask me to add a server-side proxy for the OpenAI key.</div>
      </div>
    </div>
  </div>

  <script>
    // Safe DOM getter
    const $ = id => document.getElementById(id);

    // Logging
    function log(msg){ const el = $('sfs_log'); const t = new Date().toLocaleTimeString(); el.innerHTML += `[${t}] ${msg}<br>`; el.scrollTop = el.scrollHeight; }

    function setState(state, text=''){ $('sfs_statePill').textContent = state; $('sfs_statusText').textContent = text; }

    // App state
    let running = false; let approved = []; let targetLines = 0; let tries = 0; let currentCandidate = '';

    // Demo lines (existing test cases) — keep these unchanged
    const DEMO_LINES = [
      'Stop scrolling — this one tip changed my mornings.',
      'You don’t need willpower, you need a system.',
      'Here’s a tiny habit that beats motivation every time.',
      'Most advice is noise — try this instead.',
      'If you’re juggling priorities, do this one thing.',
      'Comment START and I’ll send the step-by-step.'
    ];

    // Additional automated test: empty-line and long-line handling
    const EXTRA_TESTS = [
      '',
      'This line is intentionally long and should be truncated by the max-words logic to avoid UI overflow or unexpected behavior when the model returns very verbose text.'
    ];

    function recalcKPIs(){
      $('sfs_kpiApproved').textContent = approved.length;
      $('sfs_kpiRemaining').textContent = Math.max(0, targetLines - approved.length);
      const totalWords = approved.filter(Boolean).join(' ').trim() ? approved.filter(Boolean).join(' ').split(/\s+/).length : 0;
      const avg = approved.length ? Math.round(totalWords / approved.length) : 0;
      $('sfs_kpiWords').textContent = avg;
      $('sfs_kpiTries').textContent = tries;
    }

    function renderApproved(){
      const ol = $('sfs_approved'); ol.innerHTML = '';
      approved.forEach((line,i)=>{
        const li = document.createElement('li'); li.className = 'line approved'; li.style.margin='8px 16px'; li.textContent = line || '(skipped)'; ol.appendChild(li);
      });
      recalcKPIs();
    }

    function disableReview(disabled){ ['sfs_approve','sfs_revise','sfs_regen','sfs_skip'].forEach(id=>{ const el=$(id); if(el) el.disabled = disabled; }); }

    function extractFirstLine(text){ if(!text) return ''; const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); return lines.length ? lines[0] : text.trim(); }
    function enforceMaxWords(line, maxWords){ if(!line) return ''; const words = line.split(/\s+/); if(words.length <= maxWords) return line; return words.slice(0,maxWords).join(' ') + '…'; }

    // Robust fetch wrapper that surfaces user-friendly errors
    async function safeFetchOpenAI(url, options){
      try{
        const resp = await fetch(url, options);
        return resp;
      }catch(e){
        // If the error string contains extension names, rethrow a normalized message so UI can handle it
        const s = String(e).toLowerCase();
        if(s.includes('metamask') || s.includes('failed to connect to metamask') || s.includes('ethereum')){
          const err = new Error('Network call blocked or interfered with by a browser extension (mentions MetaMask/ethereum). Try Demo mode or disable extensions.');
          err.internal = true; throw err;
        }
        throw e;
      }
    }

    // Ask for one line (demo path preserved)
    async function askNextLine({apiKey, model, temperature, brief, maxWords, guidance=null, demo=false}){
      if(demo){ const idx = approved.length % DEMO_LINES.length; await new Promise(r=>setTimeout(r,180)); return DEMO_LINES[idx]; }

      const system = `You are a short-form video scriptwriter. Generate scripts ONE LINE AT A TIME.\nRules:\n- Reply with EXACTLY one line. No numbering, no extra commentary.\n- Keep it under ${maxWords} words.\n- Maintain continuity with the APPROVED LINES context.`;
      const context = approved.length ? `APPROVED LINES so far:\n${approved.map((l,i)=>`${i+1}. ${l}`).join('\n')}` : 'No approved lines yet.';
      const user = guidance ? `BRIEF:\n${brief}\n\n${context}\n\nRevise the PREVIOUS CANDIDATE LINE using this guidance: ${guidance}.\nReturn one improved line only.` : `BRIEF:\n${brief}\n\n${context}\n\nReturn the NEXT BEST LINE only.`;

      const body = { model, temperature: Number(temperature) || 0.6, messages:[{role:'system',content:system},{role:'user',content:user}] };

      const url = 'https://api.openai.com/v1/chat/completions';
      const options = { method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`}, body:JSON.stringify(body) };

      try{
        const resp = await safeFetchOpenAI(url, options);
        if(!resp.ok){ const txt = await resp.text(); const short = txt.length>200? txt.slice(0,200)+'…' : txt; throw new Error(`OpenAI API error ${resp.status}: ${short}`); }
        const data = await resp.json();
        const raw = data?.choices?.[0]?.message?.content || '';
        const first = extractFirstLine(raw);
        return enforceMaxWords(first, maxWords);
      }catch(err){
        // Normalize metamask-like interference to a friendly UI message
        const message = String(err.message || err).toLowerCase();
        if(message.includes('metamask') || message.includes('ethereum') || message.includes('extension')){
          // show warning box and log, but don't hard-fail (return empty candidate)
          $('sfs_warningBox').style.display = 'block';
          log(`<span style="color:#ffb6c1">Extension interference detected: ${err.message}</span>`);
          throw new Error('Extension interference detected — try Demo mode or disable extensions.');
        }
        throw err;
      }
    }

    // Generation flow
    async function generateNext(guidance=null){
      if(generateNext._inFlight) return; generateNext._inFlight = true; disableReview(true);
      try{
        const brief = $('sfs_brief').value.trim();
        const apiKey = $('sfs_apiKey').value.trim();
        const model = $('sfs_model').value.trim();
        const temperature = $('sfs_temperature').value;
        const maxWords = Number($('sfs_maxWords').value) || 14;
        const demo = $('sfs_demo').value === '1';

        if(!demo && !apiKey){ setState('Error','No API key provided (or switch to Demo mode).'); log('Missing API key.'); generateNext._inFlight = false; return; }
        if(!brief){ setState('Error','Please fill the brief.'); log('Empty brief.'); generateNext._inFlight = false; return; }

        setState('Thinking…', guidance ? 'Revising current line.' : 'Drafting next line.');
        log(guidance ? `Revising… (${guidance})` : 'Requesting next line…');

        const candidate = await askNextLine({apiKey, model, temperature, brief, maxWords, guidance, demo});
        currentCandidate = candidate || '';
        $('sfs_pending').textContent = currentCandidate || '[No content returned]';
        disableReview(false);
        $('sfs_approve').disabled = !currentCandidate;
        $('sfs_revise').disabled = !currentCandidate;
        $('sfs_regen').disabled = false; $('sfs_skip').disabled = false;
        setState('Review','Approve, revise, regenerate or skip.');
      }catch(err){
        const msg = err?.message || String(err);
        setState('Error', msg);
        log(`<span style="color:#ff7b8a">${msg}</span>`);
        disableReview(true);
      }finally{ generateNext._inFlight = false; }
    }

    function finish(){ running=false; $('sfs_start').disabled=false; $('sfs_stop').disabled=true; disableReview(true); setState('Done','Stopped.'); log('Stopped generation.'); }

    // UI wiring
    $('sfs_start').addEventListener('click', async ()=>{
      approved = []; tries = 0; currentCandidate = '';
      targetLines = Math.max(1, Number($('sfs_lines').value) || 12);
      renderApproved(); running=true; $('sfs_start').disabled=true; $('sfs_stop').disabled=false; setState('Running','Generating first line…'); await generateNext();
    });

    $('sfs_stop').addEventListener('click', finish);
    $('sfs_reset').addEventListener('click', ()=>{ approved=[]; tries=0; currentCandidate=''; renderApproved(); $('sfs_pending').textContent='No line yet. Click Start.'; setState('Idle','Ready.'); disableReview(true); $('sfs_warningBox').style.display='none'; });

    $('sfs_approve').addEventListener('click', async ()=>{ const line = (currentCandidate||'').trim(); if(!line) return; approved.push(line); renderApproved(); if(approved.length >= targetLines){ finish(); return; } setState('Running','Generating next line…'); await generateNext(); });

    $('sfs_revise').addEventListener('click', ()=>{ $('sfs_reviseBox').style.display='block'; $('sfs_reviseText').focus(); });
    $('sfs_applyRevise').addEventListener('click', async ()=>{ const g = $('sfs_reviseText').value.trim(); $('sfs_reviseBox').style.display='none'; if(!g) return; tries++; recalcKPIs(); await generateNext(g); });
    $('sfs_cancelRevise').addEventListener('click', ()=>{ $('sfs_reviseBox').style.display='none'; });
    $('sfs_regen').addEventListener('click', async ()=>{ tries++; recalcKPIs(); await generateNext(); });
    $('sfs_skip').addEventListener('click', async ()=>{ approved.push(''); renderApproved(); if(approved.length >= targetLines){ finish(); return; } await generateNext(); });

    $('sfs_copyAll').addEventListener('click', async ()=>{ const text = approved.filter(Boolean).join('\n'); try{ await navigator.clipboard.writeText(text); setState('Copied','Copied to clipboard.'); log('Copied approved lines to clipboard.'); }catch(e){ log('Clipboard write failed: ' + (e.message||e)); alert('Copy failed — your browser may block clipboard access.'); } });

    function download(filename, content){ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content],{type:'text/plain'})); a.download = filename; a.click(); URL.revokeObjectURL(a.href); }
    $('sfs_downloadTxt').addEventListener('click', ()=>{ const text = approved.filter(Boolean).join('\n'); download('script.txt',text); });
    $('sfs_downloadMd').addEventListener('click', ()=>{ const text = approved.filter(Boolean).map((l,i)=>`${i+1}. ${l}`).join('\n'); download('script.md',text); });

    // Self-test (existing test case) — keep behavior the same
    $('sfs_selftest').addEventListener('click', async ()=>{
      $('sfs_demo').value = '1'; approved = []; tries = 0; targetLines = 6; renderApproved(); setState('Running','Running demo test…');
      for(let i=0;i<6;i++){ await generateNext(); const candidate = (currentCandidate||'').trim(); if(candidate) approved.push(candidate); renderApproved(); }
      setState('Done','Demo finished.'); $('sfs_start').disabled=false; $('sfs_stop').disabled=true; log('Demo test completed.');
    });

    // Extra automated test button to exercise edge cases
    document.getElementById('sfs_simMeta').addEventListener('click', ()=>{
      // Simulate an extension-like error to verify our global handlers and warning UI
      const err = new Error('s: Failed to connect to MetaMask');
      // Dispatch an unhandledrejection and catch via our handler below
      log('Simulating extension error: "Failed to connect to MetaMask" (this will trigger the global handler).');
      // Throw inside a Promise rejection so unhandledrejection handler catches it
      Promise.reject(err);
    });

    // Global error handlers — convert noisy extension errors into friendly UI messages and prevent page crash
    window.addEventListener('error', (event)=>{
      try{
        const msg = String(event?.error?.message || event?.message || '').toLowerCase();
        if(msg.includes('metamask') || msg.includes('failed to connect to metamask') || msg.includes('ethereum')){
          event.preventDefault && event.preventDefault();
          $('sfs_warningBox').style.display = 'block';
          log(`<span style="color:#ffb6c1">Caught extension error: ${event?.error?.message || event?.message}</span>`);
          setState('Warning','Extension interference detected. See log.');
          return true;
        }
      }catch(e){/* ignore */}
      return false;
    });

    window.addEventListener('unhandledrejection', (event)=>{
      try{
        const reason = String(event?.reason?.message || event?.reason || '').toLowerCase();
        if(reason.includes('metamask') || reason.includes('failed to connect to metamask') || reason.includes('ethereum')){
          event.preventDefault && event.preventDefault();
          $('sfs_warningBox').style.display = 'block';
          log(`<span style="color:#ffb6c1">Unhandled rejection intercepted (extension-like): ${event?.reason?.message || event?.reason}</span>`);
          setState('Warning','Extension interference detected. See log.');
          return true;
        }
      }catch(e){/* ignore */}
      // For other unhandled rejections, show them but don't stop the page
      log(`<span style="color:#ff7b8a">Unhandled rejection: ${String(event?.reason || '')}</span>`);
      setState('Error','There was an unexpected error. See log.');
      return false;
    });

    // Initialization
    disableReview(true); recalcKPIs(); log('Ready. Fill the brief and either use Demo mode or provide an API key.');
  </script>
</body>
</html>
